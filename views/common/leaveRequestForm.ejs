<!DOCTYPE html>
<html lang="en" class="h-100">
  <%- include("../includes/head.ejs") %>
  <title><%= isEdit ? 'Edit' : 'Submit' %> Leave Request - Dept Connect</title>
  </head>

  <body class="d-flex flex-column h-100 bg-light">
    <%- include("../includes/navbar.ejs") %>
    
    <!-- Flash Messages -->
    <%- include("../includes/flash.ejs") %>

    <!-- Main Content -->
    <main class="flex-shrink-0">
      <div class="container mt-4">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-0 pb-0">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                    <i class="bi bi-calendar-x me-2 text-primary"></i>
                    <%= isEdit ? 'Edit' : 'Submit' %> Leave Request
                  </h5>
                  <a href="/api/leave-requests" class="btn-close"></a>
                </div>
              </div>
              <div class="card-body pt-3">
                <form 
                  action="<%= isEdit ? `/api/leave-requests/${leaveRequest._id}?_method=PUT` : '/api/leave-requests' %>" 
                  method="POST" 
                  enctype="multipart/form-data"
                  class="needs-validation"
                  novalidate
                >
                  <!-- Title/Subject -->
                  <div class="mb-3">
                    <label for="title" class="form-label">Subject <span class="text-danger">*</span></label>
                    <input 
                      type="text" 
                      class="form-control border-0 bg-light" 
                      id="title" 
                      name="title" 
                      value="<%= leaveRequest ? leaveRequest.title : '' %>"
                      placeholder="Enter leave subject/title" 
                      required
                    >
                    <div class="invalid-feedback">Please provide a subject for your leave request.</div>
                  </div>

                  <!-- Reason -->
                  <div class="mb-3">
                    <label for="reason" class="form-label">Reason <span class="text-danger">*</span></label>
                    <select class="form-select border-0 bg-light" id="reason" name="reason" required>
                      <option value="">Select reason for leave</option>
                      <option value="sick" <%= leaveRequest && leaveRequest.reason === 'sick' ? 'selected' : '' %>>Sick Leave</option>
                      <option value="personal" <%= leaveRequest && leaveRequest.reason === 'personal' ? 'selected' : '' %>>Personal Leave</option>
                      <option value="academic" <%= leaveRequest && leaveRequest.reason === 'academic' ? 'selected' : '' %>>Academic Leave</option>
                    </select>
                    <div class="invalid-feedback">Please select a reason for your leave.</div>
                  </div>

                  <!-- Date Range -->
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="fromDate" class="form-label">From Date <span class="text-danger">*</span></label>
                      <input 
                        type="date" 
                        class="form-control border-0 bg-light" 
                        id="fromDate" 
                        name="fromDate" 
                        value="<%= leaveRequest ? leaveRequest.fromDate.toISOString().split('T')[0] : '' %>"
                        min="<%= new Date().toISOString().split('T')[0] %>"
                        required
                      >
                      <div class="invalid-feedback">Please select a valid from date.</div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label for="toDate" class="form-label">To Date <span class="text-danger">*</span></label>
                      <input 
                        type="date" 
                        class="form-control border-0 bg-light" 
                        id="toDate" 
                        name="toDate" 
                        value="<%= leaveRequest ? leaveRequest.toDate.toISOString().split('T')[0] : '' %>"
                        min="<%= new Date().toISOString().split('T')[0] %>"
                        required
                      >
                      <div class="invalid-feedback">Please select a valid to date.</div>
                    </div>
                  </div>

                  <!-- Class Teacher -->
                  <div class="mb-3">
                    <label for="classTeacher" class="form-label">Class Teacher Username <span class="text-danger">*</span></label>
                    <input 
                      type="text" 
                      class="form-control border-0 bg-light" 
                      id="classTeacher" 
                      name="classTeacher" 
                      value="<%= leaveRequest ? leaveRequest.classTeacher : '' %>"
                      placeholder="Enter your class teacher's username" 
                      required
                    >
                    <div class="form-text">Enter the exact username of your class teacher who will review this request.</div>
                    <div class="invalid-feedback">Please provide your class teacher's username.</div>
                  </div>

                  <!-- File Attachment -->
                  <div class="mb-3">
                    <label for="attachment" class="form-label">
                      Attachment <%= isEdit ? '(Optional - Replace current file)' : '(Optional)' %>
                    </label>
                    <input 
                      type="file" 
                      class="form-control border-0 bg-light" 
                      id="attachment" 
                      name="attachment" 
                      accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    >
                    <div class="form-text">
                      Upload medical certificate, documents, etc. (PDF, JPG, PNG, DOC, DOCX - Max: 5MB)
                      <% if (isEdit && leaveRequest.attachmentName) { %>
                        <br><strong>Current file:</strong> <%= leaveRequest.attachmentName %>
                      <% } %>
                    </div>
                  </div>

                  <!-- Buttons -->
                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="/api/leave-requests" class="btn btn-light">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-<%= isEdit ? 'pencil' : 'send' %> me-1"></i>
                      <%= isEdit ? 'Update' : 'Submit' %> Request
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <%- include("../includes/footer.ejs") %>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Bootstrap form validation
      (function() {
        'use strict';
        window.addEventListener('load', function() {
          var forms = document.getElementsByClassName('needs-validation');
          var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
              if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add('was-validated');
            }, false);
          });
        }, false);
      })();

      // Date validation
      document.getElementById('fromDate').addEventListener('change', function() {
        document.getElementById('toDate').min = this.value;
      });
    </script>
  </body>
</html>